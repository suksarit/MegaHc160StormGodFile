=====================================================================
คู่มือรถบังคับตัดหญ้า
Mega2560 + FlySky iBUS + HC160AS2 + Storm32BGC
=====================================================================
 รายละเอียด 
- รายการอุปกรณ์ทั้งหมด (Bill of Materials)
- การเชื่อมต่อขาพินทุกจุดอย่างละเอียด
- การทำงานของโค้ดทั้งระบบ
- โครงสร้างสถาปัตยกรรมซอฟต์แวร์
- ระบบความปลอดภัย (Safety Architecture)
- ประสิทธิภาพด้านเวลา (Timing Performance)
- การทำงานของช่องสัญญาณรีโมท
- ขั้นตอนการคาลิเบรต
- การตั้งค่ารีโมทและรีซีฟเวอร์
- แนวทางป้องกัน Back EMF และ EMI
- การ Debug และ Telemetry
- ข้อจำกัดของระบบ
- จุดวิกฤตที่ต้องคำนึงถึงภาคสนาม

=====================================================================
ส่วนที่ 1 : วัตถุประสงค์ของระบบ
=====================================================================

ระบบ MegaHc160Storm32 ถูกออกแบบเพื่อควบคุมรถตัดหญ้าแบบบังคับวิทยุ
โดยให้ความสำคัญสูงสุดกับ “ความปลอดภัย” และ “ความเสถียรภาคสนาม”

หลักการออกแบบ:

- Safety-Centric Design (ความปลอดภัยมาก่อน)
- Fail-Safe First
- Hardware + Software Redundancy
- Deterministic Loop Timing
- Non-Blocking Architecture
- Fault Latching (เมื่อเกิดความผิดปกติจะไม่กลับสู่ปกติเอง)

=====================================================================
ส่วนที่ 2 : รายการอุปกรณ์หลัก (Bill of Materials)
=====================================================================

1. Arduino Mega2560 (ตัวควบคุมหลัก)
2. รีโมท FlySky i6X + รีซีฟเวอร์ FS-iA6B (รองรับ iBUS)
3. มอเตอร์ขับเคลื่อน 24V x 2 ตัว
4. ไดรเวอร์มอเตอร์กระแสสูง (เช่น HC160AS2 หรือ H-Bridge 100A)
5. เครื่องยนต์เบนซิน (ใบมีดขับทางกล)
6. Servo MG995 หรือเทียบเท่า (ควบคุมคันเร่งเครื่องยนต์)
7. ADS1115 x2 ตัว
   - ตัวที่ 1: วัดกระแส (I2C Address 0x48)
   - ตัวที่ 2: วัดแรงดัน (I2C Address 0x49)
8. Current Sensor แบบ Hall (เช่น ACS758)
9. MAX31865 x2 + PT100 x2 (วัดอุณหภูมิไดรเวอร์)
10. รีเลย์:
    - Ignition
    - Starter
    - Warning
11. Comparator Hardware Overcurrent (เอาต์พุต Open-Collector)
12. External Watchdog Module
13. พัดลม 24V x2
14. แบตเตอรี่ 24V (24–28V)
15. DC-DC Step-down 24V → 5V (แยกสำหรับ MCU)
16. ฟิวส์กำลังสูง
17. TVS Diode
18. Snubber RC
19. Ferrite Core
20. สายกราวด์แบบ Star Ground

=====================================================================
ส่วนที่ 3 : การเชื่อมต่อขาพินทั้งหมด
=====================================================================

-----------------------------
มอเตอร์ซ้าย
-----------------------------
PWM_L  (Pin 5)   → PWM Input ไดรเวอร์ซ้าย
DIR_L1 (Pin 22)  → IN1 ไดรเวอร์ซ้าย
DIR_L2 (Pin 23)  → IN2 ไดรเวอร์ซ้าย

-----------------------------
มอเตอร์ขวา
-----------------------------
PWM_R  (Pin 6)   → PWM Input ไดรเวอร์ขวา
DIR_R1 (Pin 24)  → IN1 ไดรเวอร์ขวา
DIR_R2 (Pin 25)  → IN2 ไดรเวอร์ขวา

Driver Enable
Pin 33 → EN ของไดรเวอร์ (HIGH = เปิด, LOW = ปิดทันที)

-----------------------------
พัดลม
-----------------------------
FAN_L (Pin 44) → MOSFET พัดลมซ้าย
FAN_R (Pin 45) → MOSFET พัดลมขวา

-----------------------------
Servo คันเร่ง
-----------------------------
Pin 9 → สายสัญญาณ Servo (1000–2000µs)

-----------------------------
รีเลย์
-----------------------------
Pin 28 → Ignition Relay
Pin 29 → Starter Relay
Pin 31 → Warning Relay
Pin 30 → Buzzer

-----------------------------
Overcurrent Comparator
-----------------------------
Pin 32 → เอาต์พุต comparator (INPUT_PULLUP)
HIGH = ปกติ
LOW = Overcurrent

-----------------------------
External Watchdog
-----------------------------
Pin 34 → Heartbeat toggle

-----------------------------
I2C Bus
-----------------------------
SDA → Pin 20
SCL → Pin 21

ADS1115 (Current)  → 0x48
A0 = L1
A1 = L2
A2 = R1
A3 = R2

ADS1115 (Voltage)  → 0x49
A0 = Voltage Divider

-----------------------------
PT100 (SPI)
-----------------------------
MISO → 50
MOSI → 51
SCK  → 52
MAX31865 L CS → Pin 49
MAX31865 R CS → Pin 48

-----------------------------
Serial
-----------------------------
Serial1 (Pin 19 RX1) ← iBUS จากรีซีฟเวอร์
Serial2 (Pin 17 RX2 / 16 TX2) ↔ Storm32
Serial → Debug

=====================================================================
ส่วนที่ 4 : หน้าที่ช่องสัญญาณรีโมท
=====================================================================

CH1 → เลี้ยวซ้าย-ขวา
CH2 → เดินหน้า-ถอยหลัง
CH6 → Ignition ON/OFF
CH7 → Reset
CH8 → คันเร่งเครื่องยนต์
CH10 → Starter

Storm32:
CH3 → Pitch
CH9 → Yaw

Deadband:
1450–1550 = Neutral

=====================================================================
ส่วนที่ 5 : การทำงานของโค้ด (ภาพรวมลำดับ)
=====================================================================

Boot:
- ตัด PWM
- ปิด Driver Enable
- อ่าน EEPROM fault
- Warmup 2 วินาที

INIT:
- ตรวจ PT100
- ตรวจ iBUS อยู่ในช่วงปกติ

WAIT_NEUTRAL:
- รอแรงดัน > 24.5V
- รอคันเร่งอยู่กลาง

ACTIVE:
- เปิด Driver Enable
- เริ่ม Drive + Blade

FAULT:
- ตัดมอเตอร์ทันที
- ตัด Servo
- ไม่ส่ง Heartbeat

=====================================================================
ส่วนที่ 6 : โครงสร้างสถาปัตยกรรมของระบบ
=====================================================================

ระบบแบ่งเป็น 5 ส่วนหลัก:

1. Communication Layer
2. Sensor Layer
3. Safety Layer
4. Drive & Blade Control Layer
5. Auxiliary & Gimbal Layer

ลำดับ loop():

PHASE 1: COMMS
PHASE 2: SENSORS
PHASE 3: SAFETY EVALUATION
PHASE 4: DRIVE & BLADE
PHASE 5: AUXILIARY OUTPUT
HEARTBEAT (ถ้าไม่มี Fault)

=====================================================================
ส่วนที่ 7 : ความสามารถของระบบขับเคลื่อน
=====================================================================

- PWM 15kHz
- Hybrid Steering
- Deadband Control
- Ramp Control
- Reverse Dead-Time (150ms)
- Auto Reverse
- LIMP Mode (ลดกำลัง 50%)
- Soft Stop

=====================================================================
ส่วนที่ 8 : ระบบตรวจวัด
=====================================================================

Current Monitoring (4 ช่อง)
- ADS1115
- LPF
- Plausibility
- Spike Protection
- Confirm 2 ครั้งก่อน Fault

Voltage Monitoring
- Divider 150k/33k
- Warning 2 ระดับ

Temperature Monitoring
- Warn 70C
- Limp 85C
- Trip 95C

I2C Recovery
- Timeout Detect
- Reset Bus
- Fault หากกู้ไม่สำเร็จ

=====================================================================
ส่วนที่ 9 : ระบบความปลอดภัย
=====================================================================

SafetyState:
SAFE
WARN
LIMP
EMERGENCY

Fault Types:
IBUS_LOST
COMMS_TIMEOUT
LOGIC_WATCHDOG
CUR_SENSOR_FAULT
VOLT_SENSOR_FAULT
TEMP_SENSOR_FAULT
OVER_CURRENT
OVER_TEMP
DRIVE_TIMEOUT
BLADE_TIMEOUT
LOOP_OVERRUN

Hardware Overcurrent:
Pin 32 LOW → Fault ทันที

Fault Latching:
ต้อง Reset เท่านั้น

=====================================================================
ส่วนที่ 10 : ประสิทธิภาพด้านเวลา
=====================================================================

Sensors ≤ 5 ms
Comms ≤ 3 ms
Drive ≤ 2 ms
Blade ≤ 2 ms
Loop รวม ≤ 20 ms

Worst-case loop < 20 ms
Refresh ≈ 50 Hz

ไม่มี delay()
ใช้ millis() / micros()
Non-blocking State Machine

=====================================================================
ส่วนที่ 11 : ระบบควบคุมใบมีดและเครื่องยนต์
=====================================================================

BladeState:
IDLE
RUN
SOFT_STOP
LOCKED

Engine:
- ตรวจจับเครื่องติดจากแรงดัน
- Starter Timeout
- Restart Guard
- Throttle Kill เมื่อ Fault

=====================================================================
ส่วนที่ 12 : Storm32 Gimbal Controller
=====================================================================

- Binary Protocol
- CRC16
- Dual Phase Window
- Ack Timeout 3 ระดับ
- Slew Rate Limit
- Emergency Lock
- EEPROM Configurable

State:
INIT
OK
DEGRADED
LOST
EMERGENCY

=====================================================================
ส่วนที่ 13 : การคาลิเบรต
=====================================================================

1) Current Offset
2) Voltage Divider Calibration
3) Servo Range
4) PT100 Comparison

=====================================================================
ส่วนที่ 14 : การตั้งค่ารีโมท FlySky i6X
=====================================================================

Mode 2
Output Mode → iBUS
End Point → 100%
Subtrim → 0
Deadband → ปิด

ตรวจ Serial Monitor:
1000–2000 ครบช่วง

=====================================================================
ส่วนที่ 15 : การป้องกัน Back EMF
=====================================================================

- TVS 33–36V
- Snubber RC
- Freewheel Diode
- Star Ground
- Ferrite Core
- DC-DC แยกเลี้ยง MCU

=====================================================================
ส่วนที่ 16 : การป้องกัน EMI
=====================================================================

- บิดสายมอเตอร์
- แยกสายสัญญาณ
- Pull-up 4.7k ที่ Pin 32
- Shield สาย iBUS
- Ground จุดเดียว

=====================================================================
ส่วนที่ 17 : การ Debug
=====================================================================

DEBUG_SERIAL = 1
แสดง:
SystemState
DriveState
BladeState
Current
Temp
PWM
Voltage
IBUS

TELEMETRY_CSV = 1
ส่งทุก 50ms

=====================================================================
ส่วนที่ 18 : ข้อจำกัดของระบบ
=====================================================================

- Manual RC เท่านั้น
- ไม่มี Closed-loop Speed
- ไม่มี Encoder
- ไม่ใช่มาตรฐานอุตสาหกรรม

=====================================================================
ส่วนที่ 19 : สรุปภาพรวม
=====================================================================

MegaHc160Storm32 เป็นระบบควบคุมกำลังสูง
ออกแบบเพื่อภาคสนามจริง
มีการตรวจจับความผิดปกติหลายชั้น
มี Fail-Safe ครบถ้วน

เมื่อเกิดความผิดปกติ:
→ Fault Latch
→ ตัดกำลังทันที
→ หยุด Heartbeat

=====================================================================
จบ
=====================================================================