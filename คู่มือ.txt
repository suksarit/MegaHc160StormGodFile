====================================================================
คู่มือระบบรถบังคับตัดหญ้า
Mega2560 + FlySky iBUS + HC160AS2 + Storm32BGC
TN MOWER – TECHNICAL & FIELD MANUAL
====================================================================

เนื้อหา:
1) รายการอุปกรณ์ทั้งหมด
2) โครงสร้างการทำงานของโค้ด
3) ฟังก์ชันและฟีเจอร์หลัก
4) ผังขาพินทั้งหมด
5) หน้าที่ช่องสัญญาณรีโมท
6) ขั้นตอนการใช้งาน
7) การตั้งค่าในโค้ด
8) การคาลิเบรต
9) การตั้งค่ารีโมทและรีซีฟเวอร์
10) แนวทางป้องกัน Back EMF และ EMI
11) จุดสำคัญที่ต้องคำนึง
12) Serial Monitor และ Debug
13) ข้อควรระวังภาคสนาม

====================================================================
1) รายการอุปกรณ์ทั้งหมด
====================================================================

ไมโครคอนโทรลเลอร์
• Arduino Mega2560

ระบบขับเคลื่อน
• มอเตอร์ซ้าย 1 ชุด
• มอเตอร์ขวา 1 ชุด
• Driver H-Bridge กำลังสูง (100A class)
• Comparator วงจร Hardware Overcurrent (Active LOW)

เซ็นเซอร์
• ADS1115 (กระแส) I2C address 0x48
• ADS1115 (แรงดัน) I2C address 0x49
• MAX31865 x2 (PT100 ซ้าย/ขวา)
• PT100 x2 (วัดอุณหภูมิไดรเวอร์)

ระบบเครื่องยนต์
• Servo คันเร่ง (MG995 หรือเทียบเท่า)
• Relay Ignition
• Relay Starter

รีโมท
• FlySky i6X (หรือเทียบเท่า)
• Receiver FS-iA6B (iBUS mode)

ระบบเสริม
• Storm32 BGC Gimbal
• External Watchdog (รับ heartbeat จาก Pin 34)
• พัดลมระบายความร้อน 2 ตัว

ไฟเลี้ยง
• แบตเตอรี่ 24–28V
• DC-DC 24V → 12V
• DC-DC 12V → 5V (isolated แนะนำ)

====================================================================
2) โครงสร้างการทำงานของโค้ด
====================================================================

Loop หลักแบ่งเป็น Phase:

PHASE 1: COMMS
• อ่าน iBUS
• ตรวจ timeout
• ตั้ง wdCommsOK

PHASE 2: SENSORS
• อ่านกระแสแบบ async
• อ่านแรงดันแบบ async
• อ่านอุณหภูมิทุก 100ms
• ตรวจ plausibility
• ตรวจ Overcurrent / Overtemp

PHASE 3: SAFETY
• evaluateSafetyRaw()
• updateSafetyStability()

PHASE 4: STATE MACHINE
• INIT
• WAIT_NEUTRAL
• ACTIVE
• FAULT

PHASE 5: DRIVE / BLADE
• runDrive()
• runBlade()
• applyDrive()

PHASE 6: AUX
• updateVoltageWarning()
• updateDriverFans()
• updateEngineThrottle()
• updateIgnition()
• updateStarter()
• gimbal.update()

ถ้าเกิด Fault:
• handleFaultImmediateCut()
• ไม่มี Heartbeat

====================================================================
3) ฟีเจอร์หลัก
====================================================================

ระบบขับเคลื่อน
• PWM 15kHz (Timer3/4)
• Hybrid Mixing
• Deadband 1450–1550
• Ramp acceleration
• Reverse dead-time 150ms
• Auto reverse 2 ครั้ง
• LIMP mode
• SOFT_STOP → LOCKED

ระบบป้องกัน
• IBUS soft + hard timeout
• Hardware overcurrent trip (Pin 32)
• Spike protection >120A
• Current stuck detect
• Voltage timeout detect
• Temperature trip >95°C
• Loop budget monitor
• EEPROM fault history

====================================================================
4) ผังขาพิน
====================================================================

Motor
PWM_L  → 5
PWM_R  → 6
DIR_L1 → 22
DIR_L2 → 23
DIR_R1 → 24
DIR_R2 → 25
Driver Enable → 33

Fan
FAN_L → 44
FAN_R → 45

Relay
IGNITION → 28
STARTER  → 29
BUZZER   → 30
WARN     → 31
HW Overcurrent → 32 (INPUT_PULLUP)

Watchdog
Heartbeat → 34

Temp Sensor
PT100 L CS → 49
PT100 R CS → 48

Servo
Engine Servo → 9

Serial
Serial1 → iBUS
Serial2 → Storm32
Serial  → Debug

====================================================================
5) ช่องสัญญาณรีโมท
====================================================================

CH1 → Steering
CH2 → Throttle
CH6 → Ignition
CH7 → Reset
CH8 → Engine throttle
CH10 → Starter

Storm32
CH3 → Pitch
CH9 → Yaw

Throttle mapping:
1000–1450  = Reverse
1450–1550  = Neutral
1550–2000  = Forward

====================================================================
6) ขั้นตอนการใช้งาน
====================================================================

1) เปิดระบบ
2) รอ INIT 2 วินาที
3) ตรวจว่าคันเร่งอยู่กลาง
4) ระบบเข้าสู่ ACTIVE
5) เปิด Ignition (CH6)
6) กด Starter (CH10)
7) ปรับรอบด้วย CH8
8) ขับด้วย CH1 + CH2

====================================================================
7) การตั้งค่าในโค้ด
====================================================================

Threshold ปรับได้ในส่วน:

CUR_WARN_A
CUR_LIMP_A
TEMP_WARN_C
TEMP_LIMP_C
TEMP_TRIP_C
V_WARN_LOW
V_WARN_CRITICAL

PWM_TOP = 1067 (15kHz)

Reverse Deadtime:
REVERSE_DEADTIME_MS = 150

Auto Reverse:
MAX_AUTO_REVERSE = 2

====================================================================
8) การคาลิเบรต
====================================================================

กระแส:
• ไม่มีโหลด
• วัดแรงดัน offset
• ปรับ g_acsOffsetV[i] ให้ใกล้ 2.5V

แรงดัน:
• วัดด้วยมัลติมิเตอร์
• เทียบค่า engineVolt

รีโมท:
• ตรวจค่า channel 1000–2000
• ตรวจ deadband

====================================================================
9) การตั้งค่ารีโมท
====================================================================

FlySky:
• Mode 2
• เปิด iBUS output
• Disable mixing
• Endpoint 100%
• Subtrim ให้ Neutral = 1500

Receiver:
• ต่อสาย iBUS ไป RX1
• ไม่ใช้ PPM

====================================================================
10) การป้องกัน Back EMF และ EMI
====================================================================

Back EMF:
• ใส่ TVS diode ที่ 24V rail
• ใช้ Driver ที่มี flyback diode
• ใส่ Snubber RC ที่มอเตอร์

EMI:
• แยกกราวด์ Power กับ Logic
• ใช้สาย twisted pair
• Shield สายสัญญาณ
• ใส่ Ferrite bead ที่สายมอเตอร์
• DC-DC แบบ isolated

Pull-up:
• PIN 32 ควรมี pull-up 4.7k ภายนอกถ้าสายยาว

====================================================================
11) จุดสำคัญที่ต้องคำนึง
====================================================================

• ห้าม bypass Driver Enable
• ห้าม disable Fault logic
• ตรวจแรงดันก่อนทุกครั้ง
• ตรวจพัดลมทำงาน
• ตรวจสายกราวด์แน่น
• ตรวจว่า iBUS ไม่หลุด

====================================================================
12) Serial Monitor และ Debug
====================================================================

เปิด DEBUG_SERIAL = 1

ดูข้อมูล:
• [TEL] state
• Current
• Temperature
• PWM
• Voltage
• IBUS value

Telemetry CSV:
TELEMETRY_CSV = 1
ดูผ่าน Serial Plotter

====================================================================
13) ข้อควรระวัง
====================================================================

• ห้ามทดสอบในสนามด้วย TEST_MODE
• ห้ามจ่ายไฟโดยไม่มีโหลดไดรเวอร์
• ห้ามสตาร์ทเครื่องเมื่อ Throttle ไม่อยู่กลาง
• หาก Fault เกิดซ้ำ ต้องแก้ฮาร์ดแวร์ก่อนใช้งาน
• ตรวจสอบ EMI ทุกครั้งหลังประกอบใหม่
• ห้ามใช้แหล่งจ่ายที่ไม่มีกรอง ripple

====================================================================
จบเอกสาร
====================================================================