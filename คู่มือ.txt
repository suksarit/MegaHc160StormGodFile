============================================================
คู่มือการใช้งานระบบ
Mega2560 + FlySky iBUS + HC160AS2 + Storm32BGC
RC Lawn Mower – TN Mower
============================================================

ภาพรวมระบบ
------------------------------------------------------------
ระบบนี้เป็นชุดควบคุมรถตัดหญ้าแบบบังคับวิทยุ ใช้ Arduino Mega2560
ควบคุมมอเตอร์ซ้าย–ขวา เครื่องยนต์ ใบมีด และ Storm32 Gimbal
มีระบบความปลอดภัยหลายชั้นทั้งซอฟต์แวร์และฮาร์ดแวร์

ระบบจะไม่อนุญาตให้รถขับจนกว่าจะผ่านขั้นตอนตรวจสอบความปลอดภัยครบ

============================================================
1) ฟีเจอร์หลักของระบบ
============================================================

ระบบขับเคลื่อน
• PWM 15kHz สำหรับมอเตอร์ซ้าย/ขวา
• ผสมการเลี้ยวแบบ Hybrid (Arcade + Differential)
• Deadband ป้องกันคันเร่งสั่น
• Ramp เร่ง/เบรกแบบนุ่มนวล
• Reverse Dead-time ป้องกันกลับทิศทันที
• Auto Reverse เมื่อล้อติด
• โหมด LIMP ลดกำลัง 50%
• SOFT STOP ก่อน LOCKED

ระบบตรวจวัด
• วัดกระแส 4 ช่อง (L1, L2, R1, R2) ผ่าน ADS1115
• วัดแรงดันระบบ 24–28V
• วัดอุณหภูมิไดรเวอร์ซ้าย/ขวา (PT100)
• ตรวจจับ Overcurrent
• ตรวจจับ Current Spike
• ตรวจจับ Sensor หลุด/เพี้ยน
• ตรวจจับรีโมทขาดสัญญาณ
• ตรวจจับ Loop ทำงานเกินเวลา
• บันทึก Fault ล่าสุดลง EEPROM

เมื่อเกิด FAULT:
• ตัดกำลังทันที
• ปิด Driver Enable
• ตัดคันเร่ง
• ไม่ส่ง Heartbeat ไป External Watchdog

============================================================
2) ผังขาพิน (Hardware Pin Map)
============================================================

มอเตอร์ขับเคลื่อน
PWM_L  → Pin 5
PWM_R  → Pin 6
DIR_L1 → Pin 22
DIR_L2 → Pin 23
DIR_R1 → Pin 24
DIR_R2 → Pin 25
Driver Enable → Pin 33

พัดลม
FAN_L → Pin 44
FAN_R → Pin 45

รีเลย์ / เอาต์พุต
Ignition Relay → Pin 28
Starter Relay  → Pin 29
Buzzer         → Pin 30
Warning Relay  → Pin 31
HW Overcurrent Trip → Pin 32 (INPUT_PULLUP)

Watchdog
External Watchdog Heartbeat → Pin 34

เซ็นเซอร์
PT100 ซ้าย → CS Pin 49
PT100 ขวา  → CS Pin 48
ADS1115 กระแส → I2C 0x48
ADS1115 แรงดัน → I2C 0x49

Servo
Engine Throttle Servo → Pin 9

Serial
Serial1 → FlySky iBUS
Serial2 → Storm32
Serial  → Debug

============================================================
3) หน้าที่ช่องสัญญาณรีโมท (IBUS)
============================================================

CH1  → เลี้ยวซ้าย–ขวา
CH2  → เดินหน้า–ถอยหลัง
CH6  → เปิด/ปิด Ignition
CH7  → Reset
CH8  → ควบคุมรอบเครื่องยนต์ (Servo)
CH10 → สตาร์ทเครื่องยนต์

Storm32
CH3 → Pitch
CH9 → Yaw

Throttle (CH2)
1000–1450  = ถอยหลัง
1450–1550  = ตรง (Deadband)
1550–2000  = เดินหน้า

Steering (CH1)
1000–1450  = ซ้าย
1450–1550  = ตรง
1550–2000  = ขวา

============================================================
4) ลำดับการทำงานของระบบ
============================================================

INIT
• ตัดกำลังทั้งหมด
• รอเซ็นเซอร์นิ่ง 2 วินาที

WAIT_NEUTRAL
• ตรวจแรงดันระบบ
• รอคันเร่งอยู่กลาง

ACTIVE
• เปิด Driver Enable
• อนุญาตให้ขับ

FAULT
• ตัดมอเตอร์ทันที
• ตัดคันเร่ง
• ปิด Driver Enable
• ไม่ส่ง Heartbeat

============================================================
5) ระบบเตือนแรงดัน
============================================================

≥ 24.0V  → ปกติ
23.0–24.0V → เตือน (Buzzer กระพริบ)
< 23.0V → เตือนวิกฤต (Buzzer ค้าง)

============================================================
6) ข้อควรระวังภาคสนาม
============================================================

• ห้ามใช้ TEST_MODE ในสนามจริง
• ตรวจ Neutral ก่อนเปิดใช้งาน
• ตรวจแรงดันแบตทุกครั้งก่อนเริ่มงาน
• หากเกิด FAULT ซ้ำ ต้องตรวจฮาร์ดแวร์ก่อนใช้งานต่อ
• ห้าม bypass ระบบ Driver Enable
• ตรวจสอบพัดลมทำงานเมื่ออุณหภูมิสูง

============================================================
จบ
============================================================