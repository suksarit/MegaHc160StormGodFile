=====================================================================
คู่มือฉบับเต็ม – โปรเจค RC รถบังคับตัดหญ้า
Mega2560 + FlySky iBUS + HC160AS2 + Storm32BGC
=====================================================================

เอกสารนี้อธิบาย:
- รายการอุปกรณ์ทั้งหมด
- การต่อสายทุกขา
- การทำงานของโค้ดทั้งหมด
- การตั้งค่ารีโมท
- การคาลิเบรต
- แนวทางป้องกัน EMI / Back EMF
- การ Debug และข้อควรระวังภาคสนาม

=====================================================================
1) รายการอุปกรณ์หลัก (Bill of Materials)
=====================================================================

1. Arduino Mega2560 (ตัวควบคุมหลัก)
2. รีโมท FlySky i6X + รีซีฟเวอร์ FS-iA6B (รองรับ iBUS)
3. มอเตอร์ขับเคลื่อน 24V x 2 ตัว
4. ไดรเวอร์มอเตอร์กระแสสูง (เช่น HC160AS2 หรือ H-Bridge 100A)
5. เครื่องยนต์เบนซิน (ใบมีดขับทางกล)
6. Servo MG995 หรือเทียบเท่า (ควบคุมคันเร่งเครื่องยนต์)
7. ADS1115 x2 ตัว
   - ตัวที่ 1: วัดกระแส (I2C Address 0x48)
   - ตัวที่ 2: วัดแรงดัน (I2C Address 0x49)
8. Current Sensor แบบ Hall (เช่น ACS758)
9. MAX31865 x2 + PT100 x2 (วัดอุณหภูมิไดรเวอร์)
10. รีเลย์:
    - Ignition
    - Starter
    - Warning
11. Comparator Hardware Overcurrent (เอาต์พุต Open-Collector)
12. External Watchdog Module
13. พัดลม 24V x2
14. แบตเตอรี่ 24V (24–28V)
15. DC-DC Step-down 24V → 5V (แยกสำหรับ MCU)
16. ฟิวส์กำลังสูง
17. TVS Diode
18. Snubber RC
19. Ferrite Core
20. สายกราวด์แบบ Star Ground

=====================================================================
2) การเชื่อมต่อขาพินทั้งหมด
=====================================================================

-----------------------------
มอเตอร์ซ้าย
-----------------------------
PWM_L  (Pin 5)   → PWM Input ไดรเวอร์ซ้าย
DIR_L1 (Pin 22)  → IN1 ไดรเวอร์ซ้าย
DIR_L2 (Pin 23)  → IN2 ไดรเวอร์ซ้าย

-----------------------------
มอเตอร์ขวา
-----------------------------
PWM_R  (Pin 6)   → PWM Input ไดรเวอร์ขวา
DIR_R1 (Pin 24)  → IN1 ไดรเวอร์ขวา
DIR_R2 (Pin 25)  → IN2 ไดรเวอร์ขวา

Driver Enable
Pin 33 → EN ของไดรเวอร์ (HIGH = เปิด)

-----------------------------
พัดลม
-----------------------------
FAN_L (Pin 44) → MOSFET พัดลมซ้าย
FAN_R (Pin 45) → MOSFET พัดลมขวา

-----------------------------
Servo คันเร่ง
-----------------------------
Pin 9 → สายสัญญาณ Servo

-----------------------------
รีเลย์
-----------------------------
Pin 28 → Ignition Relay
Pin 29 → Starter Relay
Pin 31 → Warning Relay
Pin 30 → Buzzer

-----------------------------
Overcurrent Comparator
-----------------------------
Pin 32 → เอาต์พุต comparator (INPUT_PULLUP)
LOW = Overcurrent

-----------------------------
External Watchdog
-----------------------------
Pin 34 → Heartbeat toggle

-----------------------------
I2C Bus
-----------------------------
SDA → Pin 20
SCL → Pin 21

ADS1115 (Current)  → 0x48
ADS1115 (Voltage)  → 0x49

-----------------------------
PT100
-----------------------------
MAX31865 L CS → Pin 49
MAX31865 R CS → Pin 48
SPI → 50, 51, 52

-----------------------------
Serial
-----------------------------
Serial1 (Pin 19 RX1) ← iBUS จากรีซีฟเวอร์
Serial2 (Pin 17 RX2) ↔ Storm32

=====================================================================
3) หน้าที่ช่องสัญญาณรีโมท
=====================================================================

CH1 → เลี้ยวซ้าย-ขวา
CH2 → เดินหน้า-ถอยหลัง
CH6 → Ignition ON/OFF
CH7 → Reset
CH8 → คันเร่งเครื่องยนต์
CH10 → Starter

Storm32:
CH3 → Pitch
CH9 → Yaw

Deadband:
1450–1550 = Neutral

=====================================================================
4) การทำงานของโค้ด (ภาพรวมลำดับ)
=====================================================================

Boot:
- ตัด PWM
- ปิด Driver Enable
- อ่าน EEPROM fault
- Warmup 2 วินาที

INIT:
- ตรวจ PT100
- ตรวจ iBUS อยู่ในช่วงปกติ

WAIT_NEUTRAL:
- รอแรงดัน > 24.5V
- รอคันเร่งอยู่กลาง

ACTIVE:
- เปิด Driver Enable
- เริ่ม Drive + Blade

FAULT:
- ตัดมอเตอร์ทันที
- ตัด Servo
- ไม่ส่ง Heartbeat

=====================================================================
5) ระบบ Safety
=====================================================================

ตรวจสอบ:
- Overcurrent
- Current Spike >120A
- Temp >95C
- IBUS Lost >300ms
- Loop Overrun
- Voltage sensor timeout
- I2C timeout

SafetyState:
SAFE
WARN
LIMP (ลด PWM 50%)
EMERGENCY (ตัดทันที)

=====================================================================
6) การคาลิเบรต
=====================================================================

1) Current Offset
- เปิดระบบโดยไม่โหลด
- ตรวจค่า curA ควรใกล้ 0A
- ถ้าไม่ใช่ ปรับ g_acsOffsetV

2) Voltage Divider
- วัดแบตด้วยมัลติมิเตอร์
- เทียบกับค่าใน Serial Monitor
- ปรับ Divider Ratio ถ้าคลาดเคลื่อน

3) Servo
- ตรวจ microseconds 1000–2000
- ปรับ Linkage ไม่ให้ดึงสุด

4) PT100
- เปรียบเทียบกับเทอร์โมมิเตอร์จริง

=====================================================================
7) การตั้งค่ารีโมท FlySky i6X
=====================================================================

Mode 2
Output Mode → iBUS
End Point → 100%
Subtrim → 0
Throttle Reverse → ตามทิศจริง
Deadband → ปิด (ใช้ในโค้ดแทน)

ตรวจค่าใน Serial Monitor:
1000–2000 ต้องครบช่วง

=====================================================================
8) การป้องกัน Back EMF
=====================================================================

จำเป็น:
- ใส่ TVS Diode 33–36V ขนานแบต
- ใส่ Snubber RC ที่มอเตอร์
- ใส่ Freewheel Diode (ถ้า H-bridge ไม่รวม)
- แยกกราวด์ MCU กับ Power แล้วรวมจุดเดียว
- ใช้สายไฟกำลังสั้นและหนา
- ใส่ Ferrite Ring ที่สายมอเตอร์
- ใช้ DC-DC แยกเลี้ยง MCU

=====================================================================
9) การป้องกัน EMI
=====================================================================

- บิดสายมอเตอร์เป็นคู่
- หลีกเลี่ยงเดินสายสัญญาณใกล้สายกำลัง
- ใส่ Pull-up ภายนอก 4.7k ที่ PIN 32
- ใช้ Shield Cable กับสาย iBUS ถ้ายาว
- ใช้ Star Ground

=====================================================================
10) Serial Monitor และ Debug
=====================================================================

เปิด DEBUG_SERIAL = 1

แสดง:
- SystemState
- DriveState
- BladeState
- กระแส 4 ช่อง
- Temp L/R
- PWM L/R
- Voltage

CSV Telemetry:
เปิด TELEMETRY_CSV = 1
ส่งข้อมูลทุก 50ms

=====================================================================
11) ข้อควรระวังภาคสนาม
=====================================================================

- ห้ามเปิด TEST_MODE ในสนามจริง
- ห้าม bypass Driver Enable
- ตรวจฟิวส์ก่อนทุกครั้ง
- ตรวจว่า Neutral จริงก่อน ACTIVE
- หาก Fault ซ้ำ ต้องแก้ฮาร์ดแวร์ก่อน
- อย่าทดสอบโดยไม่มีโหลดนานเกินไป

=====================================================================
12) จุดวิกฤตที่ต้องคำนึง
=====================================================================

- EMI จากมอเตอร์จะทำให้ I2C ค้าง
- สายกราวด์ผิดจะทำให้ Current เพี้ยน
- รีโมทขาดจะเข้าสู่ EMERGENCY ทันที
- ถ้า External Watchdog ไม่เห็น Heartbeat จะตัดระบบ

เอธิบายภาพรวมความสามารถเชิงเทคนิค โครงสร้างการทำงาน
ประสิทธิภาพด้านเวลา (Timing), ระบบความปลอดภัย และขอบเขตการทำงาน
ของโค้ดทั้งหมดในโปรเจค MegaHc160Storm32

=====================================================================
1) วัตถุประสงค์ของระบบ
=====================================================================

ระบบนี้ออกแบบมาเพื่อควบคุมรถตัดหญ้าแบบบังคับวิทยุ
โดยเน้นความปลอดภัย (Safety-Centric Design) เป็นหลัก

หลักการออกแบบ:
- Fail-Safe First
- Hardware + Software Redundancy
- Deterministic Loop Timing
- Non-Blocking Architecture
- Fault Latching (ไม่กลับสู่ปกติเอง)

=====================================================================
2) โครงสร้างสถาปัตยกรรมของระบบ
=====================================================================

ระบบแบ่งการทำงานออกเป็น 5 ส่วนหลัก:

1. Communication Layer
2. Sensor Layer
3. Safety Layer
4. Drive & Blade Control Layer
5. Auxiliary & Gimbal Layer

ลำดับการทำงานใน loop():

PHASE 1: COMMS
PHASE 2: SENSORS
PHASE 3: SAFETY EVALUATION
PHASE 4: DRIVE & BLADE
PHASE 5: AUXILIARY OUTPUT
HEARTBEAT (ถ้าไม่มี Fault)

โครงสร้างนี้ทำให้การทำงานมีความแน่นอนและตรวจจับความผิดปกติได้ชัดเจน

=====================================================================
3) ความสามารถของระบบขับเคลื่อน (Drive System)
=====================================================================

3.1 PWM ความถี่สูง 15kHz
- ลดเสียงรบกวนจากมอเตอร์
- ลด Ripple
- ควบคุมแรงบิดละเอียด

3.2 Hybrid Steering Algorithm
- ความเร็วต่ำ: Arcade Mode (หมุนในที่แคบ)
- ความเร็วสูง: Differential Mode (นิ่งเสถียร)
- มี Blend Factor ตามความเร็ว

3.3 Deadband Control
- ป้องกันคันเร่งสั่น
- ป้องกัน Drift

3.4 Ramp Control
- เร่งและเบรกแบบนุ่มนวล
- ลดกระแสกระชาก

3.5 Reverse Dead-Time (150ms)
- ป้องกัน Shoot-through
- ป้องกัน H-Bridge เสียหาย

3.6 Auto Reverse (Stuck Recovery)
- ถ้าล้อข้างใดกระแสสูงผิดปกติ
- ถอยหลังสั้น ๆ อัตโนมัติ
- จำกัดจำนวนครั้ง
- มี Cooldown

3.7 LIMP Mode
- ลดกำลัง 50%
- ใช้เมื่อโหลดสูงหรืออุณหภูมิสูง

3.8 Soft Stop
- ลด PWM ก่อนเข้าสู่ LOCKED
- ลดแรงกระชากเชิงกล

=====================================================================
4) ระบบตรวจวัด (Sensor Capabilities)
=====================================================================

4.1 Current Monitoring (4 Channels)
- อ่านผ่าน ADS1115 (860 SPS)
- LPF Filtering
- Plausibility Check
- Spike Protection
- Overcurrent Confirm 2 ครั้งก่อน Fault

4.2 Voltage Monitoring
- Divider 150k/33k
- Smoothing Filter
- Engine Running Detection
- Voltage Warning 2 ระดับ

4.3 Temperature Monitoring
- PT100 + MAX31865
- ตรวจจับ Sensor Fault
- Warn / Limp / Trip Threshold

4.4 I2C Recovery State Machine
- ตรวจจับ Timeout
- Reset Bus แบบ Non-blocking
- จำกัดจำนวนครั้ง
- Fault หากกู้ไม่สำเร็จ

=====================================================================
5) ระบบความปลอดภัย (Safety System)
=====================================================================

5.1 SafetyState
SAFE
WARN
LIMP
EMERGENCY

5.2 Fault Types
- IBUS_LOST
- COMMS_TIMEOUT
- LOGIC_WATCHDOG
- CUR_SENSOR_FAULT
- VOLT_SENSOR_FAULT
- TEMP_SENSOR_FAULT
- OVER_CURRENT
- OVER_TEMP
- DRIVE_TIMEOUT
- BLADE_TIMEOUT
- LOOP_OVERRUN

5.3 Hardware Overcurrent (PIN 32)
- Active LOW
- ตัดทันทีโดยไม่ต้องรอ I2C

5.4 Fault Latching
- เมื่อ Fault แล้วจะไม่กลับเอง
- ต้อง Reset ระบบ

5.5 Heartbeat Logic
- ส่งสัญญาณเฉพาะเมื่อ Loop สำเร็จ
- Fault → ไม่ส่ง Heartbeat

=====================================================================
6) ประสิทธิภาพด้านเวลา (Timing Performance)
=====================================================================

กำหนด Budget ชัดเจน:

Sensors   ≤ 5 ms
Comms     ≤ 3 ms
Drive     ≤ 2 ms
Blade     ≤ 2 ms
Loop รวม  ≤ 20 ms

หากเกิน Budget:
- Trigger Fault ทันที

ลักษณะการออกแบบ:
- ไม่มี delay()
- ใช้ millis() / micros()
- Non-blocking State Machine

Worst-case loop ≈ <20ms
อัตรารีเฟรชควบคุม ~50Hz

=====================================================================
7) ระบบควบคุมใบมีด / เครื่องยนต์
=====================================================================

BladeState:
IDLE
RUN
SOFT_STOP
LOCKED

Engine:
- ตรวจจับการติดเครื่องจากแรงดัน
- Starter Timeout
- Restart Guard
- Throttle Kill เมื่อ Fault

=====================================================================
8) Storm32 Gimbal Controller
=====================================================================

- Binary Protocol
- CRC16 Verification
- Dual Phase Window (Control / Comm)
- Ack Timeout 3 ระดับ
- Emergency Lock
- Slew Rate จำกัดความเร็วการหมุน
- EEPROM Configurable

State:
INIT
OK
DEGRADED
LOST
EMERGENCY

=====================================================================
9) ความเสถียรเชิงระบบ (System Robustness)
=====================================================================

- Dual Layer Overcurrent (Software + Hardware)
- Sensor Plausibility Guard
- Stuck Detection
- Loop Overrun Detection
- Watchdog ทั้งภายใน MCU และภายนอก
- Driver Enable Hardware Gate
- Soft Stop แทนการตัดทันที

=====================================================================
10) ความสามารถในการ Debug
=====================================================================

DEBUG_SERIAL = 1
แสดง:
- SystemState
- DriveState
- BladeState
- Current 4 ช่อง
- Temp L/R
- PWM L/R
- Voltage
- IBUS Raw

TELEMETRY_CSV = 1
- ส่งข้อมูลทุก 50ms
- เหมาะกับการ Plot วิเคราะห์ภาคสนาม

=====================================================================
11) ข้อจำกัดของระบบ
=====================================================================

- เป็นระบบควบคุมแบบ Manual RC (ไม่ใช่ Autonomous)
- ไม่มี Closed-loop Speed Control
- ไม่มี Encoder Feedback
- ไม่ใช่ระบบ SIL-certified
- ประสิทธิภาพขึ้นกับคุณภาพฮาร์ดแวร์ภายนอก

=====================================================================
12) สรุปความสามารถโดยรวม
=====================================================================

ระบบนี้เป็น:
- Safety-oriented Control System
- Deterministic Timing Architecture
- Multi-layer Fault Detection
- Field-ready High Current Platform
- มีระบบ Fail-Safe ครบถ้วน

ออกแบบเพื่อใช้งานภาคสนามจริง
ภายใต้สภาพแวดล้อมที่มี EMI และโหลดสูง

=====================================================================
จบเอกสาร
=====================================================================